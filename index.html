<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Manager - AZQ Edition</title>
    <style>
        :root {
            --accent-blue: #3b82f6;
            --accent-yellow: #fbbf24;
            --accent-green: #39FF14;
            --pure-black: #000000;
            --bg-main: #334155;
            --card-bg: #1e293b;
            --input-bg: #0f172a;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --footer-name-blue: #4a90e2;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .container {
            background: var(--card-bg);
            width: 95%;
            max-width: 550px;
            padding: 25px 40px; 
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            margin: 10px; 
            transition: filter 0.3s ease;
        }

        body.modal-open .container {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .header-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px; 
        }

        .header-logo .user-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--accent-yellow);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        h1 {
            font-size: 20px; 
            font-weight: 800;
            text-align: center;
            margin: 0;
            color: #ffffff;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        h1 span {
            color: var(--accent-yellow);
        }

        h3 {
            font-size: 15px; 
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px; 
            margin-bottom: 10px;
            color: var(--text-main);
            font-weight: 700;
        }

        p {
            font-size: 13px; 
            color: var(--text-muted);
            line-height: 1.4; 
            margin-bottom: 15px;
        }

        label {
            font-size: 12px; 
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
            color: var(--text-muted);
        }

        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px 14px; 
            margin-bottom: 12px; 
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-bg);
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        .radio-group-container {
            background: rgba(15, 23, 42, 0.4);
            padding: 12px 15px; 
            border-radius: 14px;
            margin: 10px 0 15px 0; 
            border: 1px solid var(--border-color);
        }

        .radio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px; 
            margin-top: 8px;
        }

        .radio-grid label {
            background: var(--card-bg);
            padding: 6px 10px; 
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            gap: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 0;
            font-size: 11px; 
            color: var(--text-main);
            transition: all 0.2s ease;
        }

        .radio-grid label:has(input:checked) {
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
            background: rgba(251, 191, 36, 0.1);
        }

        /* Tombol Lainnya diletakkan di bawah penuh */
        .radio-grid label.full-width {
            grid-column: 1 / span 2;
            justify-content: center;
            margin: 5px auto 0 auto;
            width: 50%; 
        }

        .radio-grid label:hover {
            background: var(--input-bg);
        }

        .radio-grid input[type="radio"] {
            margin: 0;
            cursor: pointer;
            flex-shrink: 0; 
            accent-color: var(--accent-yellow);
        }

        .btn-primary {
            width: 100%;
            padding: 14px; 
            background: var(--accent-blue);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--border-color);
            margin: 25px 0; 
        }

        #result-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #result-content {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            border: 2px solid var(--accent-green);
            max-width: 420px;
            width: 90%;
            text-align: center;
        }

        #bookmarkletLink {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 25px auto;
            padding: 18px 32px;
            background: var(--accent-green);
            color: #000000;
            text-decoration: none;
            border-radius: 14px;
            font-weight: 900;
            font-size: 16px;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.4);
            text-transform: uppercase;
        }

        .btn-back {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }

        #output {
            background: var(--input-bg);
            color: var(--accent-yellow);
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            border: 1px solid var(--border-color);
            min-height: 40px;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .copy-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px; 
            font-weight: 500;
            cursor: pointer;
            text-transform: lowercase;
            transition: all 0.2s;
        }

        .copy-btn.copied { background: var(--accent-green); color: black; }

        .footer {
            text-align: center;
            margin-top: 25px; 
            font-size: 10px;
            color: var(--text-muted);
        }

        .footer a.dev-name {
            color: var(--footer-name-blue); 
            text-decoration: none;
            font-weight: 700;
        }
        
        #alert-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            z-index: 3000;
            display: none;
        }

        .status-found {
            color: var(--accent-green) !important;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="alert-box"><span id="alert-text">Peringatan!</span></div>

<div id="result-overlay">
    <div id="result-content">
        <p style="color: #fff; margin-bottom: 5px; font-weight: 800; font-size: 20px;">Berhasil Dibuat!</p>
        <p style="font-size: 14px; color: var(--text-muted);">Tarik tombol hijau di bawah ke bilah <b>Bookmarks Bar</b>.</p>
        <a id="bookmarkletLink" href="#">
            <span id="bm-text-btn">Tarik Ke Bar</span>
        </a>
        <button class="btn-back" onclick="closeModalAndReset()">Kembali</button>
    </div>
</div>

<div class="container" id="mainContainer">
    <div class="header-logo" id="topHeader">
        <img src="andizzul.jpg" alt="AndizzuL" class="user-photo" onerror="this.src='https://via.placeholder.com/60/1e293b/fbbf24?text=AZQ'">
        <h1>AZQ <span>OTP MANAGER</span></h1>
    </div>
    
    <h3>Generator Bookmarklet</h3>
    <p>Konversi Secret Key menjadi tombol otomatisasi.</p>
    
    <label>Kode Secret</label>
    <input type="text" id="bookmarkletCode" placeholder="Tempel secret key">
    
    <label>Nama Bookmarklet</label>
    <input type="text" id="bookmarkletNama" placeholder="Misal: Info GTK-Andizzul">
    
    <div class="radio-group-container">
        <label>Pilih Target Aplikasi:</label>
        <div class="radio-grid">
            <!-- Kolom Kiri -->
            <label><input type="radio" name="bmOption" value="infogtk" checked> InfoGTK</label>
            <!-- Kolom Kanan -->
            <label><input type="radio" name="bmOption" value="totp_code"> SDM Data</label>
            
            <!-- Kolom Kiri -->
            <label><input type="radio" name="bmOption" value="kode2fa"> Dapodik</label>
            <!-- Kolom Kanan -->
            <label><input type="radio" name="bmOption" value="otp"> SIASN / BKN</label>
            
            <!-- Kolom Kiri -->
            <label><input type="radio" name="bmOption" value="google_belajar"> Belajar.id</label>
            <!-- Kolom Kanan -->
            <label><input type="radio" name="bmOption" value="coretax"> Coretax</label>
            
            <!-- Baris Bawah -->
            <label class="full-width"><input type="radio" name="bmOption" value="custom_target"> Lainnya</label>
        </div>
    </div>

    <button class="btn-primary" onclick="generateBookmarklet()">Buat Bookmarklet</button>

    <hr>

    <h3>QR Code Decoder</h3>
    <p id="decoderInstructions">Upload QR Code untuk mendapatkan kode secret.</p>
    <input type="file" id="fileInput" accept="image/*">
    <div id="output">Menunggu file gambar...</div>

    <div class="footer">
        Developed By <a href="https://youtu.be/29o-ych59Os" target="_blank" class="dev-name">Andizzu|L</a><br>
        AZQ - 2026
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
function showAlert(msg) {
    const box = document.getElementById('alert-box');
    document.getElementById('alert-text').textContent = msg;
    box.style.display = 'flex';
    setTimeout(() => box.style.display = 'none', 3000);
}

function smoothScrollToTop(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    const elementRect = element.getBoundingClientRect();
    const absoluteElementTop = elementRect.top + window.pageYOffset;
    const startPosition = window.pageYOffset;
    const distance = absoluteElementTop - startPosition;
    const duration = 800; 
    let start = null;

    window.requestAnimationFrame(function step(timestamp) {
        if (!start) start = timestamp;
        const progress = timestamp - start;
        const percentage = Math.min(progress / duration, 1);
        const easing = percentage < 0.5 ? 4 * percentage * percentage * percentage : 1 - Math.pow(-2 * percentage + 2, 3) / 2;
        window.scrollTo(0, startPosition + (distance * easing));
        if (progress < duration) window.requestAnimationFrame(step);
    });
}

function copyToClipboard(text, btn) {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    
    btn.textContent = "tersalin"; 
    btn.classList.add('copied');
    
    setTimeout(() => {
        btn.textContent = "salin";
        btn.classList.remove('copied');
        document.getElementById('bookmarkletCode').value = text;
        smoothScrollToTop('topHeader');
    }, 1000);
}

function closeModalAndReset() {
    document.getElementById('bookmarkletCode').value = '';
    document.getElementById('bookmarkletNama').value = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('output').innerHTML = 'Menunggu file gambar...';
    const instruct = document.getElementById('decoderInstructions');
    instruct.textContent = 'Upload QR Code untuk mendapatkan kode secret.';
    instruct.classList.remove('status-found');
    document.body.classList.remove('modal-open');
    document.getElementById('result-overlay').style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.getElementById('fileInput').addEventListener('change', function(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) processQR(code.data); else showAlert("QR Code tidak terbaca");
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
});

function processQR(qrText) {
    const outputBox = document.getElementById('output');
    const instruct = document.getElementById('decoderInstructions');
    try {
        const createAccountHtml = (name, secret) => `
            <div class="account-item">
                <div style="flex-grow:1">
                    <div style="color:#fff; font-size:11px;">${name}</div>
                    <div style="color:var(--accent-yellow); font-weight:600;">${secret}</div>
                </div>
                <button class="copy-btn" onclick="copyToClipboard('${secret}', this)">salin</button>
            </div>`;
            
        if (qrText.startsWith("otpauth://")) {
            const url = new URL(qrText);
            const secret = url.searchParams.get("secret");
            const label = decodeURIComponent(url.pathname.split(':').pop().replace(/^\/\//, ''));
            instruct.textContent = "Ditemukan 1 akun:";
            instruct.classList.add('status-found');
            outputBox.innerHTML = createAccountHtml(label, secret);
        } else if (qrText.startsWith("otpauth-migration://")) {
            const url = new URL(qrText);
            const binary = atob(url.searchParams.get("data").replace(/ /g, '+'));
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const root = protobuf.Root.fromJSON({nested:{MigrationPayload:{fields:{otpParameters:{rule:"repeated",type:"OtpParameters",id:1}}},OtpParameters:{fields:{secret:{type:"bytes",id:1},name:{type:"string",id:2},issuer:{type:"string",id:3}}}}});
            const accounts = root.lookupType("MigrationPayload").decode(bytes).otpParameters;
            instruct.textContent = `Ditemukan ${accounts.length} akun:`;
            instruct.classList.add('status-found');
            outputBox.innerHTML = accounts.map(p => createAccountHtml(p.name || p.issuer || 'Unknown', base32Encode(p.secret))).join('');
        }
    } catch (e) { showAlert("Gagal dekode QR"); }
}

function base32Encode(bytes) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = 0, value = 0, output = '';
    for (let i = 0; i < bytes.length; i++) {
        value = (value << 8) | bytes[i]; bits += 8;
        while (bits >= 5) { output += alphabet[(value >>> (bits - 5)) & 31]; bits -= 5; }
    }
    if (bits > 0) output += alphabet[(value << (5 - bits)) & 31];
    return output;
}

function generateBookmarklet() {
    const rawSecret = document.getElementById("bookmarkletCode").value.trim().replace(/\s+/g, '');
    const name = document.getElementById("bookmarkletNama").value.trim();
    const targetId = document.querySelector('input[name="bmOption"]:checked').value;
    
    if (!rawSecret || !name) {
        showAlert("Lengkapi Kode Secret dan Nama Bookmarklet!");
        return;
    }

    const jsCode = `(function(){
        var k="${rawSecret}", tid="${targetId}";
        function d32(s){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",r=0,n=0,o=[];s=s.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,"");for(var i=0;i<s.length;i++){var v=a.indexOf(s[i]);n=(n<<5)|v;r+=5;if(r>=8){o.push((n>>>(r-8))&255);r-=8}}return new Uint8Array(o)}
        function i2b(n){var b=new ArrayBuffer(8),v=new DataView(b);v.setUint32(4,n>>>0);v.setUint32(0,Math.floor(n/4294967296));return new Uint8Array(b)}
        async function g(){
            var sk=d32(k),t=Math.floor(Date.now()/30000),msg=i2b(t);
            var key=await crypto.subtle.importKey("raw",sk,{name:"HMAC",hash:"SHA-1"},false,["sign"]);
            var sig=await crypto.subtle.sign("HMAC",key,msg);
            var h=new Uint8Array(sig),off=h[h.length-1]&15;
            var otp=((h[off]&127)<<24|(h[off+1]&255)<<16|(h[off+2]&255)<<8|(h[off+3]&255))%1000000;
            var code=otp.toString().padStart(6,"0");
            
            if(tid==="totp_code"){
                /* Logika Khusus SDM Data - Auto Fill & Auto Submit */
                var el = document.getElementById("totp_code") || document.querySelector('input[name="totp_code"]');
                if(el){ 
                    el.value=code; 
                    el.dispatchEvent(new Event('input', {bubbles:true}));
                    setTimeout(function(){ 
                        var b=document.querySelector('button[type="submit"]'); 
                        if(b) b.click(); 
                    }, 200);
                } else alert("OTP SDM Data: " + code);
            } else if(tid==="infogtk"){
                var inputs=document.querySelectorAll("#otpForm .otp-input");
                if(inputs.length){code.split("").forEach((c,i)=>{if(inputs[i]){inputs[i].value=c;inputs[i].dispatchEvent(new Event('input'))}})}
                else alert("OTP GTK: " + code);
            } else if(tid==="google_belajar"){
                var el = document.querySelector('input[type="tel"]') || document.querySelector('input[name="totpPin"]');
                if(el){ el.value=code; el.dispatchEvent(new Event('input', {bubbles:true})); }
                else alert("OTP Belajar.id: " + code);
            } else if(tid==="coretax"){
                var el = document.querySelector('input[name="otp"], input[name="token"], .p-inputtext[placeholder*="OTP"]');
                if(el){ el.value=code; el.dispatchEvent(new Event('input', {bubbles:true})); el.dispatchEvent(new Event('change', {bubbles:true})); }
                else alert("OTP Pajak: " + code);
            } else if(tid==="custom_target"){
                var el = document.activeElement && document.activeElement.tagName === "INPUT" ? document.activeElement : document.querySelector('input[type="text"], input[type="tel"]');
                if(el) { el.value = code; el.dispatchEvent(new Event('input', {bubbles:true})); }
                var c = document.createElement("textarea"); c.value = code; document.body.appendChild(c); c.select(); document.execCommand("copy"); document.body.removeChild(c);
                alert("OTP: " + code + " (Disalin)");
            } else {
                var el=document.getElementById(tid);
                if(el){el.value=code;el.dispatchEvent(new Event('change'))}
                else alert("OTP: " + code);
            }
        }
        g().catch(e=>alert("Error: "+e.message));
    })()`;

    document.getElementById("bookmarkletLink").href = "javascript:" + encodeURIComponent(jsCode);
    document.getElementById("bm-text-btn").textContent = name;
    document.body.classList.add('modal-open');
    document.getElementById('result-overlay').style.display = 'flex';
}
</script>
</body>
</html>